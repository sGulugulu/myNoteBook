[Intro to CUDA (part 1): High Level Concepts](https://www.youtube.com/watch?v=4APkMJdiudU)


### threads & block & grid
![[Pasted image 20251125191123.png]]
它们之间可以看作包含关系,一个thread被映射到一个cuda core , 多个thread 组成 block , 多个block组成grid, grid被映射为整个设备
但是每个thread在启动的时候是启动整个grid

Warp的原语操作
1. 投票函数  `__all_sync `,`__any_sync`
2. 洗牌指令(Shuffle) : `__shfl_sync`  , `__shfl_up_sync`
3. Warp归约: `__shfl_down_sync`
## 硬件上
对应示意图

| Software     | Hardware  |
| ------------ | --------- |
| Thread       | CUDA Core |
| Thread Block | SM        |
| Grid         | Device    |


SP, CUDA Core :
SP: Streaming Processor  fermi架构之前(Tesla , Fermi)的叫法
	每个SP都有自己的registers 和local memory ,只能被自己访问,不同的SP之间独立
CUDA Core:Fermi架构之后(Kepler开始)

二者没有本质区别,都是负责执行单精度浮点运算和整数运算的基本单元

随着架构演进,出现双精度浮点单元DPU, 张量核心 Tensor Core ,而CUDA Core 特指负责单精度计算的核心

CUDA Core 结构:
![[Pasted image 20251205151427.png]]

SM: Streaming MultiProcessor  一个SM中有多个CUDA Core , 架构不同,数量不同,  SM还有特殊运算单元(SFU),共享内存(shared memory ) , 寄存器(Register) ,调度器(Warp Scheduler)
寄存器和共享内存是稀缺资源, 限制active warps,进而限制并行能力

Warp:
**一个Warp是32个连续线程的集合，这些线程在SM（流多处理器）上以锁步（lock-step）方式同时执行相同的指令。**

**Warp是CUDA执行模型的核心**：
- ✅ **32个线程**作为一个执行单元.warp是sm的基本执行单元
- ✅ **锁步执行**：所有线程同时执行相同指令
	- **锁步执行**是指在一个执行单元（如CUDA的warp）中，所有线程**同时执行完全相同的指令**，但可能操作不同的数据。
- ✅ **分支发散是性能杀手**：避免warp内线程走不同路径
- ✅ **内存访问要合并**：确保warp访问连续内存地址
- ✅ **利用warp原语**：`__shfl_`, `__vote_`, `__sync`等指令
- 一个warp中的线程必然在同一个block中,如果block所含线程数目不是wap大小的整数倍,那么多出的thread所在的warp中,会剩余一些inactive的thread,这些thread也会消耗sm资源,warp大小一般为32,所以block所含的thread大小一般为32的倍数

GPU内存架构:
全局内存:global memory  映射到硬件的HBM显存上
共享内存:shared memory 是SM上的片上内存,容量小,速度快,不属于显存
                         GPU内存架构详细图解
                         
                    +--------------------------+
                    |      主机内存 (CPU)       |
                    |  (通过PCIe/NVLink访问)    |
                    +--------------------------+
                              |
                    +--------------------------+
                    |     GPU全局内存 (DRAM)    |
                    |  (显存，高延迟，高带宽)    |
                    +--------------------------+
         ________________| | | | |_________________
        |           |           |           |           |
    +-------+   +-------+   +-------+   +-------+   +-------+
    | L2缓存 |   | 纹理   |   | 常量   |   | 表面   |   | L2缓存 |
    |       |   | 缓存   |   | 缓存   |   | 缓存   |   |       |
    +-------+   +-------+   +-------+   +-------+   +-------+
        |           |           |           |           |
    +-------------------------------------------------------+
    |             流多处理器 (SM) 阵列                       |
    +-------------------------------------------------------+
    |  SM 0               SM 1               SM N           |
    | +---------------+ +---------------+ +---------------+ |
    | | 指令缓存       | | 指令缓存       | | 指令缓存       | |
    | | 常量缓存       | | 常量缓存       | | 常量缓存       | |
    | | 纹理缓存       | | 纹理缓存       | | 纹理缓存       | |
    | | L1缓存/共享内存 | | L1缓存/共享内存 | | L1缓存/共享内存 | |
    | | 寄存器文件     | | 寄存器文件     | | 寄存器文件     | |
    | | 线程束调度器   | | 线程束调度器   | | 线程束调度器   | |
    | | 执行单元       | | 执行单元       | | 执行单元       | |
    | +---------------+ +---------------+ +---------------+ |
    +-------------------------------------------------------+